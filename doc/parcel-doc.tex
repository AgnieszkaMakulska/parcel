\documentclass[11pt]{article}
\pdfoutput=1
\usepackage[utf8]{inputenc}
%\usepackage[tiny]{titlesec}
%\usepackage{latexsym,nicefrac,multirow}

%\usepackage{savetrees}
%\linespread{1.16}
%\setlength{\footskip}{20pt}

\usepackage{indentfirst}
\setlength{\parindent}{0.4cm}
\usepackage{microtype}
\usepackage[hmarginratio=1:1,top=24mm,bottom=20mm,left=17mm,right=17mm,columnsep=20pt]{geometry}
\usepackage[pdftex]{graphicx}
\usepackage{caption}


\usepackage{filecontents}
\begin{filecontents}{\jobname.bib}

  @article{Arabas_et_al_2015,
         title = {libcloudph++ 1.0: single-moment bulk, double-moment bulk, and particle-based warm-rain microphysics library in C++},
        author = {Arabas, S. and Jaruga, A. and Pawlowska, H. and Grabowski, W.W.},
       journal = {Geosci. Model. Dev.},
          year = {2015},
          note = {submitted, arXiv:\href{http://arxiv.org/abs/1310.1905}{1310.1905}}
  }

  @book{Lin_2012a,
         title = {A Hands-On Introduction to Using Python in the Atmospheric and Oceanic Sciences},
        author = {Lin, J. W.-B.},
          year = {2012},
          isbn = {130007616X}
  }

  @article{Arabas_et_al_2014,
         title = {Formula translation in Blitz++, NumPy and modern Fortran: A case study of~the language choice tradeoffs},
        author = {Arabas, S. and Jarecka, D. and Jaruga, A. and Fija≈Çkowski, M.},
       journal = {Sci. Prog.}, 
           doi = {10.3233/SPR-140379},
        volume = {22},
         pages = {201--222},
          year = {2014}
  }

  @article{Petters_et_al_2007,
         title = {A single parameter representation of~hygroscopic growth and cloud condensation nucleus activity},
        author = {Petters, M.D. and Kreidenweis, S.M},
       journal = {Atmos. Chem. Phys.},
          year = {2007},
        volume = {7},
           doi = {10.5194/acp-8-6273-2008},
         pages = {1961--1971}
  }

  @book{Curry_and_Webster_1999,
    author = {Curry, J.A. and Webster, P.J.},
    title = {Thermodynamics of Atmospheres and Oceans},
    year = {1999},
    publisher = {Academic Press}
  }

  @misc{Thrust,
    author = {Hoberock, J. and Bell, N.},
    title = {Thrust: A Parallel Template Library},
    year = {2010},
    url = {http://thrust.github.io/}
  }

  @article{Arabas_and_Pawlowska_2011,
         title = {Adaptive method of lines for multi-component aerosol condensational growth and CCN activation},
        author = {Arabas, S. and Pawlowska, H.},
       journal = {Geosci. Model. Dev.},
          year = {2011},
        volume = {4},
         pages = {15--31},
           doi = {10.5194/gmd-4-15-2011}
  }

\end{filecontents}

%\usepackage{xcolor,hyperref}
%\usepackage[colorlinks=true,allcolors=blue]{hyperref}

\usepackage[backend=bibtex,natbib=true,maxbibnames=99,firstinits=true]{biblatex}
\addbibresource{\jobname.bib}

\renewbibmacro{in:}{%
  \ifentrytype{article}{}{%
  \printtext{\bibstring{in}\intitlepunct}}}

\date{} % arXiv anyhow adds the date of submission on the page margin

% listings
\usepackage{fancyvrb,relsize}
\fvset{frame=single,framerule=.2mm,fontsize=\relscale{.6}}
\input{lst/pygments}

\newcommand*\FancyVerbStartString{}
\newcommand*\FancyVerbStopString{}

\newcommand{\codepyt}[4]{%
  \refstepcounter{Listing}%
  \fvset{label=Listing~\theListing#4}%
  \fvset{gobble=#3}%
  \renewcommand*\FancyVerbStartString{\PY{c}{\PYZsh{}\PYZlt{}listing\PYZhy{}#2\PYZgt{}}}%
  \renewcommand*\FancyVerbStopString{\PY{c}{\PYZsh{}\PYZlt{}/listing\PYZhy{}#2\PYZgt{}}}%
  \input{#1}%
  \vspace{-1.5em}%
}

\newcommand{\codefor}[4]{%
  \refstepcounter{Listing}%
  \fvset{label=Listing~\theListing#4}%
  \fvset{gobble=#3}%
  \renewcommand*\FancyVerbStartString{\PY{c}{!\PYZlt{}listing\PYZhy{}#2\PYZgt{}}}%
  \renewcommand*\FancyVerbStopString{\PY{c}{!\PYZlt{}/listing\PYZhy{}#2\PYZgt{}}}%
  \input{#1}%
  \vspace{-1.5em}%
}

\newcommand{\codetxt}[4]{%
  \refstepcounter{Listing}%
  \fvset{label=Listing~\theListing#4}%
  \fvset{gobble=#3}%
  \renewcommand*\FancyVerbStartString{\PYZsh{}\PYZlt{}listing\PYZhy{}#2\PYZgt{}}%
  \renewcommand*\FancyVerbStopString{\PYZsh{}\PYZlt{}/listing\PYZhy{}#2\PYZgt{}}%
  \input{#1}%
  \vspace{-1.5em}%
}

\usepackage{float}
\newfloat{Listing}{hbtp}{lop}

\newcommand{\prog}[1]{{\tt#1}}

% title page
\usepackage{authblk}
%\author[1]{Sylwester Arabas}
%\author[1,2]{Dorota Jarecka}
%\author[1]{Anna Jaruga}
%\author[1]{Anna Zimniak}
%\affil[1]{Institute of Geophysics, Faculty of Physics, University of Warsaw, Poland}
%\affil[2]{National Center for Atmospheric Research, USA}

\title{Parcel model documentation}

\begin{document}
\maketitle

%\twocolumn[
%  \begin{@twocolumnfalse}
%    \maketitle
%    \begin{abstract}
%    \end{abstract}
%    \vspace{2em}
%  \end{@twocolumnfalse}
%]

\section{Introduction}\label{sec:intro}

The parcel model simulates zero - dimensional air parcel, which is adiabatically risen with constant vertical velocity. In the parcel there is aerosol distribution and water vapour mixing ratio specified. The model solves equations for temperature and pressure. Change of these variables in every timestep determines the water vapour condensation.

Actual state variables (potential temperature, density of dry air and water vapour mixing ratio) are passed on to microphysics library. It solves condensation equantions for every 'super-droplet', which represents particles attributed to one bin in the spectrum. This bins are moving, while spectrum is evaluating, which means that a size of each 'super-droplet' is changing. Nevertheless every 'super-droplet' still represents the same group of particles, which are growing with time. 'Super-droplets' are lagrangian descritption of microphysics. It is 'lagrangian', because it calculates evolution of the spectrum, by tracing changes of each bin.

The parcel model enables tracing the evolution of droplet spectrum with time starting with given initial conditions. Simultaneously it gives information about the evolution of state variables and the amount of water vapour.

\section{Solved equations}\label{sec:eqs}
\subsection{Solving for pressure}

Microphysics library needs actual value of density of dry air. To calculate it, there is helper pressure profile needed. To calculate the helper pressure profile, the hydrostatic equation has to be integrated:

\begin{equation}
	\frac{dp}{dz} = -\rho g,
	\label{hydro}
\end{equation}

\noindent{where p - pressure, z - vertical displacement, $\rho$ - density of air, g - gravitational acceleration.}

In the model there are three methods for integrating the hydrostatic equation:

1) Assuming constant potential temperature, $\theta$, and constant water vapour mixing ratio, $r_v$. Then $\rho$ is specified by this constant values and pressure profile is retrieved;

2) Integrating equation (\ref{hydro}) by assuming constant $\rho$;

3) Integrating equation (\ref{hydro}) by assuming piecewise constant $\rho$.

\subsection{Open/closed system for chemistry}

\section{Arguments}

The model takes following optional arguments:

\begin{itemize}
	\item \textbf{dt} : float (default = 0.1) \newline Timestep [s]
	\item \textbf{z\_max} : float (default = 200) \newline Maximum vertical displacement [m]
	\item \textbf{w} : float (default = 1) \newline Updraft velocity [m/s]
	\item \textbf{T\_0} : float (default = 300) \newline Initial temperature [K]
	\item \textbf{p\_0} : float (default = 101300) \newline Initial pressure [Pa]
	\item \textbf{r\_0} : float (default = 0.022) \newline Initial water vapour mass mixing ratio [kg/kg]
	\item \textbf{outfile} : string (default = "test.nc") \newline Output netCDF file name
	\item \textbf{outfreq} : int (default = 100) \newline Output interval (in number of time steps)
	\item \textbf{sd\_conc} : int (default = 64) \newline Number of moving bins (super-droplets)
	\item \textbf{kappa} : float (default = 0.5) \newline Kappa hygroscopicity parameter \newline (see doi:10.5194/acp-7-1961-2007)
	\item \textbf{mean\_r} : float (default = 0.04$\cdot10^{-6}$) \newline Lognormal distribution mode radius [m]
	\item \textbf{gstdev} : float (default = 1.4) \newline Lognormal distribution geometric standard deviation [1]
	\item \textbf{n\_tot} : float (default = 60$\cdot10^{6}$) \newline Lognormal distribution total concentration under standard conditions (T = 20C, p = 1013.25 hPa, r = 0) [m\textsuperscript{-3}]
	\item \textbf{out\_bin} : jason string \newline (default = '\{"radii": \{"rght": 0.0001, "moms": [0], "drwt": "dry", "nbin": 26, "lnli": "log", "left": 1e-09\}\}') \newline Dictionary of dictionaries defining spectrum diagnostics, i.e.: \newline '\{"radii": \{"rght": 0.0001, "moms": [0], "drwt": "wet", "nbin": 26, "lnli": "log", "left": 1e-09\}, \newline "cloud": \{"rght": 2.5e-05, "moms": [0, 1, 2, 3], "drwt": "wet", "nbin": 49, "lnli": "lin", "left": 5e-07\}\}' 

In the example, there are two variables defined: "radii" and "cloud". In a brace after a variable name, there are several output spectrum characteristics. "rght" and "left" specify right hand side and left hand side egde of the spectrum (in meters). Square bracket named "moms" consists of a list of numbers, specyfying moments of the spectrum. "drwt" has two possible values: "dry" for dry aerosol spectrum and "wet" for wet particles. "nbin" is a number of bins and "lnli" allows to determine, if they would be spaced linearly ("lin") or logaritmically ("log") between the edges.

Example dictionary of dictionaries will generate five output spectra:

- 0-th spectrum moment for 26 bins spaced logaritmically between 0 and $10^{-4}$ m for dry radius;

- 0, 1, 2 and 3-rd moments for 49 bins spaced linearly between $0.5\cdot10^{-6}$ and $25\cdot10^{-6}$ m for wet radius.

\item \textbf{pprof} : string (default = "pprof\_piecewise\_const\_rhod") \newline Specification of a way of counting helper pressure profile. This variable can have three possible values corresponding do three methods descibed in the section "solving for pressure":

1) "pprof\_const\_th\_rv" - constant potential temperature and water vapour mixing ratio;

2) "pprof\_const\_rhod" - constant density of dry air;

3) "pprof\_piecewise\_const\_rhod" - piecewise constant density of dry air.

\end{itemize}

\section{Output}

Output files format is netCDF. It includes information about all input and output variables. It also includes information about maximum relative humidity (RH\_max) reached during the simulation.

Data are attributed to the names of variables. For example, variable 'p' consists of a list of values of pressure reached during the simulation. The number of data in each variable equals to the number od timesteps, which is $\frac{z_{max}}{v\cdot dt}$, divided by the output interval, outfreq. 

In the output file, there are data for subsequent variables:
\begin{itemize}
	\item \textbf{t} - time [s];
	\item \textbf{z} - vertical displacement [m];
	\item \textbf{p} - pressure [Pa];
	\item \textbf{r\_v} - water vapour mixing ratio [kg/kg];
	\item \textbf{RH} - relative humidity [1];
	\item \textbf{T} - temperature [K];
	\item \textbf{th\_d} - dry potential temperature [K].

There are also variables describing spectrum for each variable defined in the dictionary 'out\_bin'. For example, if there was variable named 'radii', specified to be 'wet' and generate 0,1 and 2-nd moment of spectrum, in the output file there would be:
	\item \textbf{radii\_r\_wet} - left bin edge of spectrum histogram [m];
	\item \textbf{radii\_dr\_wet} - distance between the edges [m].

Variables describing moments of spectrum consist of a list of lists. Every one list consists of values attributed to bins in actual spectrum. The number of elements in the list equals to the number of bins. This lists of moments of spectrum woud be (for example case) in subsequent variables:
	\item \textbf{radii\_m0} - 0-th moment of spectrum;
	\item \textbf{radii\_m1} - 1-st moment of spectrum;
	\item \textbf{radii\_m2} - 2-nd moment of spectrum.
\end{itemize}

The content of the output file could be seen by writing subsequent command in terminal:

\vspace{0.35cm}
\noindent{ncdump test.nc}
\vspace{0.35cm}

\section{Usage examples}
\subsection{python}

To run the model in python, with all default parameters, there should be subsequent command written in terminal:

\vspace{0.35cm}
\noindent{python parcel.py}
\vspace{0.35cm}

\noindent{This command will generate an output file.} There is a possibility to change the input parameters by adding them to the command, which runs the model. For example:

\vspace{0.35cm}
\noindent{python parcel.py \texttt{--}outfile 'test2.nc' \texttt{--}p\_0 100000 \texttt{--}T\_0 280 \texttt{--}r\_v0 0.025}
\vspace{0.35cm}

\noindent{will generate an output file 'test2.nc' including results of the simulation, which starts with subsequent initial conditions: pressure 1000 hPa, temperature 280 K and water vapour mixing ratio 25 g/kg. Other input parameters will be default.} There is a possibility to specify any of the input parameter in that way.

To get a variable from the output file (for example T), subsequent commands should be written in python:

\vspace{0.35cm}
\noindent{from scipy.io import netcdf}

\noindent{data = netcdf.netcdf\_file('test.nc','r')}

\noindent{T = data.variables['T'][:]}
\vspace{0.35cm}

\subsection{gdl/idl}
\subsection{matlab}
\subsection{bash}
 
%\begin{Listing}
%  \codepyt{lst/git_revision.py}{1}{0}{}
%  \label{lst:git_revision}
%\end{Listing}
  
\appendix

\section{Installation}\label{sec:install}

\section*{Acknowledgements}
\footnotesize

\renewcommand*{\bibfont}{\footnotesize}
\printbibliography

\end{document}
